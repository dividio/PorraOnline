<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
				xmlns:h="http://java.sun.com/jsf/html" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:a4j="http://richfaces.org/a4j"
                xmlns:rich="http://richfaces.org/rich" 
				template="/WEB-INF/templates/template.xhtml">

<f:metadata>
    <f:viewParam name="idPartida" value="#{administrarResultadosBean.idPartida}"/>
</f:metadata>

<ui:define name="side_menu">
    <ui:include src="/jsf/partidas/MenuPartida.xhtml"/>
</ui:define>

<ui:define name="body">
    <h1>Administrar Resultados</h1>
    <h2>#{administrarResultadosBean.partida}</h2>
    <a4j:outputPanel rendered="#{administrarResultadosBean.partida.pa_id == null}">
        <p>No tienes permisos para administrar esta partida.</p>
    </a4j:outputPanel>
    <h:form rendered="#{administrarResultadosBean.partida.pa_id != null}">
        <a4j:outputPanel rendered="#{administrarResultadosBean.evento == null}">
            <p>No hay ningún próximo evento previsto.</p>
        </a4j:outputPanel>
        <a4j:outputPanel id="panelEvento" rendered="#{administrarResultadosBean.evento != null}">
        
            <a4j:commandLink value="Buscar Eventos" 
                    action="#{administrarResultadosBean.cargarListaEventos}"
                    render="panelBuscadorEventos"
                    oncomplete="#{rich:component('panelBuscadorEventos')}.show();"/>
            <article>
                <p>
                    #{administrarResultadosBean.evento.ev_nombre} <br/>
                    #{administrarResultadosBean.evento.ev_lugar} - (
                    <h:outputText value="#{administrarResultadosBean.evento.ev_fecha_evento}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                    </h:outputText>)
                </p>
                <p>
                    Se pueden introducir los resultados a partir del 
					<h:outputText value="#{administrarResultadosBean.evento.ev_fecha_limite_pronosticos}">
					   <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                    </h:outputText>
                </p>
                <p><a href="#{administrarResultadosBean.evento.ev_url_referencia}" target="_blank">Más información</a></p>
	        </article>
	        
	        <a4j:outputPanel rendered="#{administrarResultadosBean.hayCambios}">
            <p>
                ATENCIÓN: Has hecho cambios en los resultados y aún no lo has guardado.
	        </p>
	        </a4j:outputPanel>
	        
	        <div class="menu_horizontal">
                <a4j:commandLink value="Guardar Resultado" 
                    rendered="#{administrarResultadosBean.editable}"
                    action="#{administrarResultadosBean.guardarResultados}"
                    render="panelEvento"/>
		        <a4j:commandLink value="Agregar #{administrarResultadosBean.partida.pa_alias_competidores}" 
                    rendered="#{administrarResultadosBean.editable}"
		            render="panelCompetidores"
		            oncomplete="#{rich:component('panelCompetidores')}.show();"/>
            </div>
	        <rich:dataTable styleClass="table table-striped table-bordered" id="listaPronosticos" value="#{administrarResultadosBean.listaResultados}" var="resultado" >
                <f:facet name="header">#{administrarResultadosBean.evento.ev_nombre}: resultados</f:facet>
                <rich:column>
                    <f:facet name="header">Posición</f:facet>
                    #{resultado.re_posicion}
                </rich:column>
                <rich:column>
                    <f:facet name="header">#{administrarResultadosBean.partida.pa_alias_competidores}</f:facet>
                    #{resultado.re_co_id}
                </rich:column>
                <rich:column rendered="#{administrarResultadosBean.editable}">
                    <f:facet name="header">Opciones</f:facet>
                    <div class="menu_horizontal">
                        <a4j:commandLink value="Subir"
                                rendered="#{administrarResultadosBean.editable}" 
                                action="#{administrarResultadosBean.subirResultado}"
                                render="panelEvento">
                            <f:setPropertyActionListener target="#{administrarResultadosBean.resultado}" value="#{resultado}"/>
                        </a4j:commandLink>
                        
                        <a4j:commandLink value="Bajar"
                                rendered="#{administrarResultadosBean.editable}" 
                                action="#{administrarResultadosBean.bajarResultado}"
                                render="panelEvento">
                            <f:setPropertyActionListener target="#{administrarResultadosBean.resultado}" value="#{resultado}"/>
                        </a4j:commandLink>
                        
                        <a4j:commandLink value="Eliminar"
                                rendered="#{administrarResultadosBean.editable}" 
                                action="#{administrarResultadosBean.eliminarResultado}"
	                            render="panelEvento">
	                        <f:setPropertyActionListener target="#{administrarResultadosBean.resultado}" value="#{resultado}"/>
	                    </a4j:commandLink>
                    </div>
                </rich:column>
	        </rich:dataTable>
	    </a4j:outputPanel>
    </h:form>
    
    <rich:popupPanel  id="panelCompetidores" onmaskclick="#{rich:component('panelCompetidores')}.hide();" autosized="true" onshow="adaptarPopupPanel(panelCompetidores);">
        <h:form>
            <rich:dataTable styleClass="table table-striped table-bordered" value="#{administrarResultadosBean.listaResultadosSinAsignar}" var="resultado" rows="15">
                <f:facet name="header">Lista de #{administrarResultadosBean.partida.pa_alias_competidores}</f:facet>
                <rich:column>
                    <a4j:commandLink action="#{administrarResultadosBean.agregarResultado}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelCompetidores')}.hide();">
                        <h:outputText value="#{resultado.re_co_id.co_nombre}"/>
                        <f:setPropertyActionListener target="#{administrarResultadosBean.resultado}" value="#{resultado}"/>
                    </a4j:commandLink> 
                </rich:column>
                <f:facet name="footer">
	                <rich:dataScroller renderIfSinglePage="false" fastControls="hide">
                    <f:param name="idPartida" value="#{administrarResultadosBean.idPartida}"/>
                </rich:dataScroller>
	            </f:facet>
            </rich:dataTable>
        </h:form>
    </rich:popupPanel>
    
    <rich:popupPanel id="panelBuscadorEventos" onmaskclick="#{rich:component('panelBuscadorEventos')}.hide();" autosized="true" onshow="adaptarPopupPanel(panelBuscadorEventos);">
        <h:form>
            <rich:dataTable styleClass="table table-striped table-bordered" value="#{administrarResultadosBean.listaEventos}" var="evento" rows="10">
                <f:facet name="header">Lista de Eventos</f:facet>
                <rich:column>
                    <f:facet name="header">Evento</f:facet>
                    <a4j:commandLink action="#{administrarResultadosBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_nombre}"/>
                        <f:setPropertyActionListener target="#{administrarResultadosBean.evento}" value="#{evento}"/>
                    </a4j:commandLink> 
                </rich:column>
                <rich:column>
	                <f:facet name="header">Fecha Evento</f:facet>
	                <a4j:commandLink action="#{administrarResultadosBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_evento}">
	                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
	                    </h:outputText>
                        <f:setPropertyActionListener target="#{administrarResultadosBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
	            </rich:column>
	            <rich:column>
                    <f:facet name="header">Fecha Inicio Pronósticos</f:facet>
                    <a4j:commandLink action="#{administrarResultadosBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_inicio_pronosticos}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                        </h:outputText>
                        <f:setPropertyActionListener target="#{administrarResultadosBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
                </rich:column>
	            <rich:column>
	                <f:facet name="header">Fecha Límite Pronósticos</f:facet>
	                <a4j:commandLink action="#{administrarResultadosBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_limite_pronosticos}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                        </h:outputText>
                        <f:setPropertyActionListener target="#{administrarResultadosBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
	            </rich:column>
                <f:facet name="footer">
                    <rich:dataScroller renderIfSinglePage="false" fastControls="hide">
                    <f:param name="idPartida" value="#{administrarResultadosBean.idPartida}"/>
                </rich:dataScroller>
                </f:facet>
            </rich:dataTable>
        </h:form>
    </rich:popupPanel>
</ui:define>

</ui:composition>