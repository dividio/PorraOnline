<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
				xmlns:h="http://java.sun.com/jsf/html" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:a4j="http://richfaces.org/a4j"
                xmlns:rich="http://richfaces.org/rich" 
				template="/WEB-INF/templates/template.xhtml">

<f:metadata>
    <f:viewParam name="idPartida" value="#{proximoEventoBean.idPartida}" required="true" />
</f:metadata>

<ui:define name="side_menu">
    <ui:include src="/jsf/partidas/MenuPartida.xhtml"/>
</ui:define>

<ui:define name="body">
    <h1>Próximo Evento</h1>
    <h2>#{proximoEventoBean.partida}</h2>
	<h:form>
        <a4j:outputPanel rendered="#{proximoEventoBean.evento == null}">
            <p>No hay ningún próximo evento previsto.</p>
        </a4j:outputPanel>
        <a4j:outputPanel id="panelEvento" rendered="#{proximoEventoBean.evento != null}">
        
            <a4j:commandLink value="Buscar Eventos" 
                    action="#{proximoEventoBean.cargarListaEventos}"
                    render="panelBuscadorEventos"
                    oncomplete="#{rich:component('panelBuscadorEventos')}.show();"/>
            <article>
                <p>
                    #{proximoEventoBean.evento.ev_nombre} <br/>
                    #{proximoEventoBean.evento.ev_lugar} - (
                    <h:outputText value="#{proximoEventoBean.evento.ev_fecha_evento}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                    </h:outputText>)
                </p>
                <p>
                    Se pueden hacer pronósticos desde el
					<h:outputText value="#{proximoEventoBean.evento.ev_fecha_inicio_pronosticos}">
					   <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
					</h:outputText> 
					hasta el 
					<h:outputText value="#{proximoEventoBean.evento.ev_fecha_limite_pronosticos}">
					   <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                    </h:outputText>
                </p>
                <p><a href="#{proximoEventoBean.evento.ev_url_referencia}" target="_blank">Más información</a></p>
	        </article>
	        
	        <a4j:outputPanel rendered="#{proximoEventoBean.hayCambios}">
            <p>
                ATENCIÓN: Has hecho cambios en tu pronóstico y aún no lo has guardado.
	        </p>
	        </a4j:outputPanel>
	        
	        <div class="menu_horizontal">
                <a4j:commandLink value="Guardar Pronóstico" 
                    rendered="#{proximoEventoBean.editable}"
                    action="#{proximoEventoBean.guardarPronostico}"
                    render="panelEvento"/>
		        <a4j:commandLink value="Agregar #{proximoEventoBean.partida.pa_alias_competidores}" 
                    rendered="#{proximoEventoBean.editable}"
		            render="panelCompetidores"
		            oncomplete="#{rich:component('panelCompetidores')}.show();"/>
            </div>
	        <rich:dataTable id="listaPronosticos" value="#{proximoEventoBean.listaPronosticos}" var="pronostico" >
                <f:facet name="header">#{proximoEventoBean.evento.ev_nombre}: Tu pronóstico para el evento</f:facet>
                <rich:column width="10%">
                    <f:facet name="header">Posición</f:facet>
                    #{pronostico.pr_posicion}
                </rich:column>
                <rich:column width="70%">
                    <f:facet name="header">#{proximoEventoBean.partida.pa_alias_competidores}</f:facet>
                    #{pronostico.pr_co_id}
                </rich:column>
                <rich:column width="20%">
                    <f:facet name="header">Opciones</f:facet>
                    <div class="menu_horizontal">
                        <a4j:commandLink value="Subir"
                                rendered="#{proximoEventoBean.editable}" 
                                action="#{proximoEventoBean.subirPronostico}"
                                render="panelEvento">
                            <f:setPropertyActionListener target="#{proximoEventoBean.pronostico}" value="#{pronostico}"/>
                        </a4j:commandLink>
                        
                        <a4j:commandLink value="Bajar"
                                rendered="#{proximoEventoBean.editable}" 
                                action="#{proximoEventoBean.bajarPronostico}"
                                render="panelEvento">
                            <f:setPropertyActionListener target="#{proximoEventoBean.pronostico}" value="#{pronostico}"/>
                        </a4j:commandLink>
                        
                        <a4j:commandLink value="Eliminar"
                                rendered="#{proximoEventoBean.editable}" 
                                action="#{proximoEventoBean.eliminarPronostico}"
	                            render="panelEvento">
	                        <f:setPropertyActionListener target="#{proximoEventoBean.pronostico}" value="#{pronostico}"/>
	                    </a4j:commandLink>
                    </div>
                </rich:column>
	        </rich:dataTable>
	    </a4j:outputPanel>
    </h:form>
    
    <rich:popupPanel id="panelCompetidores" onmaskclick="#{rich:component('panelCompetidores')}.hide();" autosized="true">
        <h:form>
            <rich:dataTable value="#{proximoEventoBean.listaPronosticosSinAsignar}" var="pronostico" rows="15">
                <f:facet name="header">Lista de #{proximoEventoBean.partida.pa_alias_competidores}</f:facet>
                <rich:column>
                    <a4j:commandLink action="#{proximoEventoBean.agregarPronostico}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelCompetidores')}.hide();">
                        <h:outputText value="#{pronostico.pr_co_id.co_nombre}"/>
                        <f:setPropertyActionListener target="#{proximoEventoBean.pronostico}" value="#{pronostico}"/>
                    </a4j:commandLink> 
                </rich:column>
                <f:facet name="footer">
	                <rich:dataScroller renderIfSinglePage="false" />
	            </f:facet>
            </rich:dataTable>
        </h:form>
    </rich:popupPanel>
    
    <rich:popupPanel id="panelBuscadorEventos" onmaskclick="#{rich:component('panelBuscadorEventos')}.hide();" autosized="true">
        <h:form>
            <rich:dataTable value="#{proximoEventoBean.listaEventos}" var="evento" rows="10">
                <f:facet name="header">Lista de Eventos</f:facet>
                <rich:column>
                    <f:facet name="header">Evento</f:facet>
                    <a4j:commandLink action="#{proximoEventoBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_nombre}"/>
                        <f:setPropertyActionListener target="#{proximoEventoBean.evento}" value="#{evento}"/>
                    </a4j:commandLink> 
                </rich:column>
                <rich:column>
	                <f:facet name="header">Fecha Evento</f:facet>
	                <a4j:commandLink action="#{proximoEventoBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_evento}">
	                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
	                    </h:outputText>
                        <f:setPropertyActionListener target="#{proximoEventoBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
	            </rich:column>
	            <rich:column>
                    <f:facet name="header">Fecha Inicio Pronósticos</f:facet>
                    <a4j:commandLink action="#{proximoEventoBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_inicio_pronosticos}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                        </h:outputText>
                        <f:setPropertyActionListener target="#{proximoEventoBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
                </rich:column>
	            <rich:column>
	                <f:facet name="header">Fecha Límite Pronósticos</f:facet>
	                <a4j:commandLink action="#{proximoEventoBean.cargarNuevoEvento}"
                            render="panelEvento"
                            oncomplete="#{rich:component('panelBuscadorEventos')}.hide();">
                        <h:outputText value="#{evento.ev_fecha_limite_pronosticos}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" timeZone="#{loginBean.timeZone}"/>
                        </h:outputText>
                        <f:setPropertyActionListener target="#{proximoEventoBean.evento}" value="#{evento}"/>
                    </a4j:commandLink>
	            </rich:column>
                <f:facet name="footer">
                    <rich:dataScroller renderIfSinglePage="false" />
                </f:facet>
            </rich:dataTable>
        </h:form>
    </rich:popupPanel>
</ui:define>

</ui:composition>